'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var React = require('react');
require('@dynamic-labs/sdk-api');
var logger = require('../../../shared/logger.cjs');
require('@dynamic-labs/iconic');
require('@dynamic-labs/wallet-connector-core');
require('react/jsx-runtime');
require('../../ViewContext/ViewContext.cjs');
require('@dynamic-labs/wallet-book');
require('../../../utils/constants/colors.cjs');
require('../../../utils/constants/values.cjs');
require('../../../shared/utils/classes/storage/localStorage.cjs');
require('viem');
require('@dynamic-labs/utils');
require('../../../shared/consts/index.cjs');
require('../../../../../_virtual/_tslib.cjs');
require('@dynamic-labs/multi-wallet');
var getAuthToken = require('../../../utils/functions/getAuthToken/getAuthToken.cjs');
require('viem/chains');

const useCustomerCallbacks = ({ callbacks: { onAuthSuccess, onLinkSuccess, onUserProfileUpdate, onEmbeddedWalletCreated, }, handleLogOut, primaryWallet, secondaryWallets, user, isAuthenticated, setIsVerificationInProgress, setHasLoggedOut, }) => {
    const [callbackQueue, setCallbackQueue] = React.useState([]);
    /** Gets the wallet from its id */
    const getWallet = React.useCallback((id) => {
        var _a;
        return id
            ? (_a = [primaryWallet, ...secondaryWallets].find((wallet) => (wallet === null || wallet === void 0 ? void 0 : wallet.id) === id)) !== null && _a !== void 0 ? _a : undefined
            : undefined;
    }, [primaryWallet, secondaryWallets]);
    const handleNextCallback = React.useCallback((next, authToken, user) => {
        var _a, _b;
        switch (next === null || next === void 0 ? void 0 : next.callback) {
            case 'authSuccess': {
                try {
                    setIsVerificationInProgress(false);
                    onAuthSuccess === null || onAuthSuccess === void 0 ? void 0 : onAuthSuccess({
                        authToken,
                        handleLogOut,
                        isAuthenticated,
                        primaryWallet,
                        user,
                        walletConnector: primaryWallet === null || primaryWallet === void 0 ? void 0 : primaryWallet.connector,
                    });
                    setHasLoggedOut(false);
                }
                catch (e) {
                    logger.logger.error('Error calling onAuthSuccess: ', e);
                }
                break;
            }
            case 'linkSuccess': {
                try {
                    const wallet = getWallet((_a = next.params) === null || _a === void 0 ? void 0 : _a.walletId);
                    onLinkSuccess === null || onLinkSuccess === void 0 ? void 0 : onLinkSuccess({
                        authToken,
                        user,
                        wallet,
                        walletConnector: wallet === null || wallet === void 0 ? void 0 : wallet.connector,
                    });
                }
                catch (e) {
                    logger.logger.error('Error calling onLinkSuccess: ', e);
                }
                break;
            }
            case 'userProfileUpdate': {
                try {
                    onUserProfileUpdate === null || onUserProfileUpdate === void 0 ? void 0 : onUserProfileUpdate(user);
                }
                catch (e) {
                    logger.logger.error('Error calling userProfileUpdate: ', e);
                }
                break;
            }
            case 'embeddedWalletCreated': {
                try {
                    onEmbeddedWalletCreated === null || onEmbeddedWalletCreated === void 0 ? void 0 : onEmbeddedWalletCreated((_b = next.params) === null || _b === void 0 ? void 0 : _b.verifiedCredential);
                }
                catch (e) {
                    logger.logger.error('Error calling onEmbeddedWalletCreated: ', e);
                }
            }
        }
    }, [
        getWallet,
        handleLogOut,
        isAuthenticated,
        onAuthSuccess,
        onEmbeddedWalletCreated,
        onLinkSuccess,
        onUserProfileUpdate,
        primaryWallet,
        setHasLoggedOut,
        setIsVerificationInProgress,
    ]);
    React.useEffect(() => {
        if (!callbackQueue.length || !user)
            return;
        const authToken = getAuthToken.getAuthToken();
        // checks if user logged in with a wallet, so we need to wait
        // for the primary wallet state to be set
        // if user logged in with email without embedded wallet, then
        // there is no wallet so we can go ahead and run the callback
        if (!authToken || (user.isAuthenticatedWithAWallet && !primaryWallet)) {
            return;
        }
        handleNextCallback(callbackQueue[0], authToken, user);
        setCallbackQueue((prev) => {
            const [resolvedCallback, ...updatedQueue] = prev;
            if (resolvedCallback) {
                logger.logger.debug('Resolved callback: ', resolvedCallback.callback);
                logger.logger.debug('Callbacks in queue: ', updatedQueue.map((c) => c.callback));
            }
            return updatedQueue;
        });
    }, [callbackQueue, handleNextCallback, primaryWallet, user]);
    const setCallback = (callback, params) => {
        setCallbackQueue((prev) => [...prev, { callback, params }]);
    };
    return { setCallback };
};

exports.useCustomerCallbacks = useCustomerCallbacks;
