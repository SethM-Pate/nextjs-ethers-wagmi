import { useCallback, useEffect } from 'react';
import { isSameAddress } from '@dynamic-labs/wallet-connector-core';
import { DynamicError } from '@dynamic-labs/utils';
import { isWalletLinked } from '../../../functions/isWalletLinked/isWalletLinked.js';
import { useViewContext } from '../../../../context/ViewContext/ViewContext.js';
import '../../../../context/DynamicContext/DynamicContext.js';
import '@dynamic-labs/sdk-api';
import { logger } from '../../../../shared/logger.js';
import '@dynamic-labs/iconic';
import 'react/jsx-runtime';
import '@dynamic-labs/wallet-book';
import '../../../constants/colors.js';
import '../../../constants/values.js';
import '../../../../shared/utils/classes/storage/localStorage.js';
import 'viem';
import '../../../../shared/consts/index.js';
import '../../../../events/dynamicEvents.js';
import '../../../../../../_virtual/_tslib.js';
import '../../../../context/CaptchaContext/CaptchaContext.js';
import '../../../../context/ErrorContext/ErrorContext.js';
import '@dynamic-labs/multi-wallet';
import 'viem/chains';
import '../../../../context/AccessDeniedContext/AccessDeniedContext.js';
import '../../../../context/AccountExistsContext/AccountExistsContext.js';
import '../../../../config/ApiEndpoint.js';
import '../../../../context/EmailVerificationContext/EmailVerificationContext.js';
import 'react-dom';
import '../../../../context/ThemeContext/ThemeContext.js';
import '@dynamic-labs/types';
import 'yup';
import 'react-i18next';
import '../../../../context/MockContext/MockContext.js';
import '../../useUserUpdateRequest/useUpdateUser/useUpdateUser.js';
import '../../../../context/UserFieldEditorContext/UserFieldEditorContext.js';
import '@dynamic-labs/rpc-providers';
import '../../../../context/UserWalletsContext/UserWalletsContext.js';
import '../../../../components/Alert/Alert.js';
import '../../../../components/ShadowDOM/ShadowDOM.js';
import '../../../../components/IconButton/IconButton.js';
import '../../../../components/InlineWidget/InlineWidget.js';
import '../../../../components/IsBrowser/IsBrowser.js';
import '../../../../components/MenuList/Dropdown/Dropdown.js';
import '../../../../components/Transition/ZoomTransition/ZoomTransition.js';
import '../../../../components/Transition/SlideInUpTransition/SlideInUpTransition.js';
import '../../../../components/Transition/OpacityTransition/OpacityTransition.js';
import '../../../../components/Popper/Popper/Popper.js';
import '../../../../components/Popper/PopperContext/PopperContext.js';
import 'react-focus-lock';
import 'qrcode';
import 'formik';
import '../../../../locale/locale.js';
import '../../../../components/OverlayCard/OverlayCard.context.js';
import '../../../../components/PasskeyCreatedSuccessBanner/PasskeyCreatedSuccessBanner.js';
import '../../../../context/PasskeyContext/PasskeyContext.js';
import '../../../../views/WalletList/WalletList.js';
import '@hcaptcha/react-hcaptcha';
import '../../../../context/LoadingContext/LoadingContext.js';
import '../../../../context/SocialRedirectContext/SocialRedirectContext.js';
import '../../../../context/WalletGroupContext/WalletGroupContext.js';
import '../../../../widgets/DynamicBridgeWidget/views/WalletsView/components/SecondaryWallets/SecondaryWallets.js';
import '../../../../context/FooterAnimationContext/index.js';
import '../../../../widgets/DynamicWidget/components/DynamicWidgetHeader/DynamicWidgetHeader.js';
import '../../../../widgets/DynamicWidget/context/DynamicWidgetContext.js';
import '../../../../components/UserProfile/parts/UserProfileField/components/VerifiedEmailIcon/VerifiedEmailIcon.js';
import '@dynamic-labs/viem-utils';
import '../../../../views/TransactionConfirmationView/helpers/transactionErrorMessage.js';
import '../../useTransactionWithGasPrice/useTransactionWithGasPrice.js';
import '../../../../widgets/DynamicWidget/views/ManagePasskeysWidgetView/PasskeyCard/PasskeyCard.js';
import { useInternalDynamicContext } from '../../../../context/DynamicContext/useDynamicContext/useInternalDynamicContext.js';
import { MISSING_ADDRESS_ERROR } from '../../../constants/errors.js';

const useSyncPrimaryWallet = (canSync = true) => {
    const { setShowAuthFlow, isAuthenticated, authMode, connectWallet, handleLogOut, multiWalletWidgetState, primaryWallet, secondaryWallets, setMultiWalletWidgetState, setPrimaryWallet, setShowWidgetStatePopup, showLockedWalletView, showWidgetStatePopup, setSelectedWalletWithAction, } = useInternalDynamicContext();
    const { setView } = useViewContext();
    const handlePrimaryWalletNotActive = useCallback((connectedAddress) => {
        if (!primaryWallet)
            return;
        if (authMode === 'connect-only') {
            connectWallet(primaryWallet.connector);
            return;
        }
        const connectedWalletIsLinked = isWalletLinked(connectedAddress, [
            primaryWallet,
            ...secondaryWallets,
        ]);
        if (!connectedWalletIsLinked) {
            // MM returns all connected wallets now, so we need to check if the active account
            // is not in the same wallet as the primary wallet before automatically switching
            // to a connected secondary wallet as it was causing an infinite loop
            const connectedSecondaryWallet = secondaryWallets.find((wallet) => wallet.connected && primaryWallet.connector !== wallet.connector);
            if (!connectedSecondaryWallet) {
                setSelectedWalletWithAction({
                    action: 'select',
                    wallet: primaryWallet,
                });
                setMultiWalletWidgetState('awaiting_account_switch', 'primary_not_connected');
                return;
            }
            setPrimaryWallet(connectedSecondaryWallet.id);
            return;
        }
        if (showWidgetStatePopup) {
            // user updates wallet address in the widget
            setShowWidgetStatePopup(false);
            setMultiWalletWidgetState('awaiting_account_switch', 'switching_primary');
            return;
        }
        // !showWidgetStatePopup - user comes back to site with different wallet address
        const connectedWallet = secondaryWallets.find((wallet) => wallet.connected &&
            isSameAddress(wallet.address, connectedAddress, wallet.chain));
        if (connectedWallet) {
            setPrimaryWallet(connectedWallet.id);
            return;
        }
        setMultiWalletWidgetState('awaiting_account_switch', 'primary_not_connected');
    }, [
        primaryWallet,
        authMode,
        secondaryWallets,
        showWidgetStatePopup,
        setMultiWalletWidgetState,
        setPrimaryWallet,
        setShowWidgetStatePopup,
        connectWallet,
    ]);
    useEffect(() => {
        if (!canSync)
            return;
        if (!primaryWallet || multiWalletWidgetState !== 'idle')
            return;
        if (primaryWallet.connector.connectedChain === 'FLOW')
            return;
        if (primaryWallet.connector.connectedChain === 'COSMOS')
            return;
        primaryWallet.connector
            .getConnectedAccounts()
            .then((accounts) => {
            logger.debug('Sync primary wallet - getConnectedAccounts', {
                accounts,
                primaryWalletAddress: primaryWallet.address,
            });
            const [connectedAddress] = accounts;
            if (!connectedAddress) {
                throw new DynamicError('Missing wallet address', MISSING_ADDRESS_ERROR);
            }
            if (isSameAddress(connectedAddress, primaryWallet.address, primaryWallet.chain)) {
                return;
            }
            handlePrimaryWalletNotActive(connectedAddress);
        })
            .catch((e) => {
            const connectedSecondaryWallet = secondaryWallets.find((wallet) => wallet.connected);
            if (connectedSecondaryWallet) {
                setPrimaryWallet(connectedSecondaryWallet.id);
                return;
            }
            // user is logged in (has valid jwt), but no wallet is connected
            if (isAuthenticated && e.code === MISSING_ADDRESS_ERROR) {
                if (!primaryWallet.connector.isInstalledOnBrowser()) {
                    handleLogOut();
                    return;
                }
                if (showLockedWalletView) {
                    setShowAuthFlow(true);
                    setView('wallet-locked-view');
                }
            }
        });
    }, [
        primaryWallet,
        secondaryWallets,
        multiWalletWidgetState,
        setMultiWalletWidgetState,
        handlePrimaryWalletNotActive,
        handleLogOut,
        setPrimaryWallet,
        canSync,
        setView,
        setShowAuthFlow,
        authMode,
        isAuthenticated,
        showLockedWalletView,
    ]);
};

export { useSyncPrimaryWallet };
