'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var React = require('react');
var walletConnectorCore = require('@dynamic-labs/wallet-connector-core');
var utils = require('@dynamic-labs/utils');
var isWalletLinked = require('../../../functions/isWalletLinked/isWalletLinked.cjs');
var ViewContext = require('../../../../context/ViewContext/ViewContext.cjs');
require('../../../../context/DynamicContext/DynamicContext.cjs');
require('@dynamic-labs/sdk-api');
var logger = require('../../../../shared/logger.cjs');
require('@dynamic-labs/iconic');
require('react/jsx-runtime');
require('@dynamic-labs/wallet-book');
require('../../../constants/colors.cjs');
require('../../../constants/values.cjs');
require('../../../../shared/utils/classes/storage/localStorage.cjs');
require('viem');
require('../../../../shared/consts/index.cjs');
require('../../../../events/dynamicEvents.cjs');
require('../../../../../../_virtual/_tslib.cjs');
require('../../../../context/CaptchaContext/CaptchaContext.cjs');
require('../../../../context/ErrorContext/ErrorContext.cjs');
require('@dynamic-labs/multi-wallet');
require('viem/chains');
require('../../../../context/AccessDeniedContext/AccessDeniedContext.cjs');
require('../../../../context/AccountExistsContext/AccountExistsContext.cjs');
require('../../../../config/ApiEndpoint.cjs');
require('../../../../context/EmailVerificationContext/EmailVerificationContext.cjs');
require('react-dom');
require('../../../../context/ThemeContext/ThemeContext.cjs');
require('@dynamic-labs/types');
require('yup');
require('react-i18next');
require('../../../../context/MockContext/MockContext.cjs');
require('../../useUserUpdateRequest/useUpdateUser/useUpdateUser.cjs');
require('../../../../context/UserFieldEditorContext/UserFieldEditorContext.cjs');
require('@dynamic-labs/rpc-providers');
require('../../../../context/UserWalletsContext/UserWalletsContext.cjs');
require('../../../../components/Alert/Alert.cjs');
require('../../../../components/ShadowDOM/ShadowDOM.cjs');
require('../../../../components/IconButton/IconButton.cjs');
require('../../../../components/InlineWidget/InlineWidget.cjs');
require('../../../../components/IsBrowser/IsBrowser.cjs');
require('../../../../components/MenuList/Dropdown/Dropdown.cjs');
require('../../../../components/Transition/ZoomTransition/ZoomTransition.cjs');
require('../../../../components/Transition/SlideInUpTransition/SlideInUpTransition.cjs');
require('../../../../components/Transition/OpacityTransition/OpacityTransition.cjs');
require('../../../../components/Popper/Popper/Popper.cjs');
require('../../../../components/Popper/PopperContext/PopperContext.cjs');
require('react-focus-lock');
require('qrcode');
require('formik');
require('../../../../locale/locale.cjs');
require('../../../../components/OverlayCard/OverlayCard.context.cjs');
require('../../../../components/PasskeyCreatedSuccessBanner/PasskeyCreatedSuccessBanner.cjs');
require('../../../../context/PasskeyContext/PasskeyContext.cjs');
require('../../../../views/WalletList/WalletList.cjs');
require('@hcaptcha/react-hcaptcha');
require('../../../../context/LoadingContext/LoadingContext.cjs');
require('../../../../context/SocialRedirectContext/SocialRedirectContext.cjs');
require('../../../../context/WalletGroupContext/WalletGroupContext.cjs');
require('../../../../widgets/DynamicBridgeWidget/views/WalletsView/components/SecondaryWallets/SecondaryWallets.cjs');
require('../../../../context/FooterAnimationContext/index.cjs');
require('../../../../widgets/DynamicWidget/components/DynamicWidgetHeader/DynamicWidgetHeader.cjs');
require('../../../../widgets/DynamicWidget/context/DynamicWidgetContext.cjs');
require('../../../../components/UserProfile/parts/UserProfileField/components/VerifiedEmailIcon/VerifiedEmailIcon.cjs');
require('@dynamic-labs/viem-utils');
require('../../../../views/TransactionConfirmationView/helpers/transactionErrorMessage.cjs');
require('../../useTransactionWithGasPrice/useTransactionWithGasPrice.cjs');
require('../../../../widgets/DynamicWidget/views/ManagePasskeysWidgetView/PasskeyCard/PasskeyCard.cjs');
var useInternalDynamicContext = require('../../../../context/DynamicContext/useDynamicContext/useInternalDynamicContext.cjs');
var errors = require('../../../constants/errors.cjs');

const useSyncPrimaryWallet = (canSync = true) => {
    const { setShowAuthFlow, isAuthenticated, authMode, connectWallet, handleLogOut, multiWalletWidgetState, primaryWallet, secondaryWallets, setMultiWalletWidgetState, setPrimaryWallet, setShowWidgetStatePopup, showLockedWalletView, showWidgetStatePopup, setSelectedWalletWithAction, } = useInternalDynamicContext.useInternalDynamicContext();
    const { setView } = ViewContext.useViewContext();
    const handlePrimaryWalletNotActive = React.useCallback((connectedAddress) => {
        if (!primaryWallet)
            return;
        if (authMode === 'connect-only') {
            connectWallet(primaryWallet.connector);
            return;
        }
        const connectedWalletIsLinked = isWalletLinked.isWalletLinked(connectedAddress, [
            primaryWallet,
            ...secondaryWallets,
        ]);
        if (!connectedWalletIsLinked) {
            // MM returns all connected wallets now, so we need to check if the active account
            // is not in the same wallet as the primary wallet before automatically switching
            // to a connected secondary wallet as it was causing an infinite loop
            const connectedSecondaryWallet = secondaryWallets.find((wallet) => wallet.connected && primaryWallet.connector !== wallet.connector);
            if (!connectedSecondaryWallet) {
                setSelectedWalletWithAction({
                    action: 'select',
                    wallet: primaryWallet,
                });
                setMultiWalletWidgetState('awaiting_account_switch', 'primary_not_connected');
                return;
            }
            setPrimaryWallet(connectedSecondaryWallet.id);
            return;
        }
        if (showWidgetStatePopup) {
            // user updates wallet address in the widget
            setShowWidgetStatePopup(false);
            setMultiWalletWidgetState('awaiting_account_switch', 'switching_primary');
            return;
        }
        // !showWidgetStatePopup - user comes back to site with different wallet address
        const connectedWallet = secondaryWallets.find((wallet) => wallet.connected &&
            walletConnectorCore.isSameAddress(wallet.address, connectedAddress, wallet.chain));
        if (connectedWallet) {
            setPrimaryWallet(connectedWallet.id);
            return;
        }
        setMultiWalletWidgetState('awaiting_account_switch', 'primary_not_connected');
    }, [
        primaryWallet,
        authMode,
        secondaryWallets,
        showWidgetStatePopup,
        setMultiWalletWidgetState,
        setPrimaryWallet,
        setShowWidgetStatePopup,
        connectWallet,
    ]);
    React.useEffect(() => {
        if (!canSync)
            return;
        if (!primaryWallet || multiWalletWidgetState !== 'idle')
            return;
        if (primaryWallet.connector.connectedChain === 'FLOW')
            return;
        if (primaryWallet.connector.connectedChain === 'COSMOS')
            return;
        primaryWallet.connector
            .getConnectedAccounts()
            .then((accounts) => {
            logger.logger.debug('Sync primary wallet - getConnectedAccounts', {
                accounts,
                primaryWalletAddress: primaryWallet.address,
            });
            const [connectedAddress] = accounts;
            if (!connectedAddress) {
                throw new utils.DynamicError('Missing wallet address', errors.MISSING_ADDRESS_ERROR);
            }
            if (walletConnectorCore.isSameAddress(connectedAddress, primaryWallet.address, primaryWallet.chain)) {
                return;
            }
            handlePrimaryWalletNotActive(connectedAddress);
        })
            .catch((e) => {
            const connectedSecondaryWallet = secondaryWallets.find((wallet) => wallet.connected);
            if (connectedSecondaryWallet) {
                setPrimaryWallet(connectedSecondaryWallet.id);
                return;
            }
            // user is logged in (has valid jwt), but no wallet is connected
            if (isAuthenticated && e.code === errors.MISSING_ADDRESS_ERROR) {
                if (!primaryWallet.connector.isInstalledOnBrowser()) {
                    handleLogOut();
                    return;
                }
                if (showLockedWalletView) {
                    setShowAuthFlow(true);
                    setView('wallet-locked-view');
                }
            }
        });
    }, [
        primaryWallet,
        secondaryWallets,
        multiWalletWidgetState,
        setMultiWalletWidgetState,
        handlePrimaryWalletNotActive,
        handleLogOut,
        setPrimaryWallet,
        canSync,
        setView,
        setShowAuthFlow,
        authMode,
        isAuthenticated,
        showLockedWalletView,
    ]);
};

exports.useSyncPrimaryWallet = useSyncPrimaryWallet;
