{"version":3,"file":"account-signer.js","sourceRoot":"","sources":["../../../../src/kernel-zerodev/ethers-provider/account-signer.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  resolveProperties,\n  type AccountMiddlewareFn,\n  type FeeDataMiddleware,\n  type GasEstimatorMiddleware,\n  type PaymasterAndDataMiddleware,\n  type PublicErc4337Client,\n  type SignTypedDataParams,\n} from \"@alchemy/aa-core\";\nimport {\n  Signer,\n  type TypedDataSigner,\n  type TypedDataDomain,\n  type TypedDataField,\n} from \"@ethersproject/abstract-signer\";\nimport { hexlify } from \"@ethersproject/bytes\";\nimport { _TypedDataEncoder } from \"@ethersproject/hash\";\nimport type { Deferrable } from \"@ethersproject/properties\";\nimport {\n  type TransactionRequest,\n  type TransactionResponse,\n} from \"@ethersproject/providers\";\nimport { ZeroDevEthersProvider } from \"./ethers-provider.js\";\nimport type { SupportedValidators } from \"../validator/types.js\";\nimport type { KernelSmartContractAccount } from \"../account.js\";\nimport type { Hex } from \"viem\";\n\nconst hexlifyOptional = (value: any): `0x${string}` | undefined => {\n  if (value == null) {\n    return undefined;\n  }\n\n  return hexlify(value) as `0x${string}`;\n};\n\nexport class ZeroDevAccountSigner<V extends SupportedValidators>\n  extends Signer\n  implements TypedDataSigner\n{\n  private account?: KernelSmartContractAccount;\n\n  sendUserOperation;\n  waitForUserOperationTransaction;\n\n  constructor(readonly provider: ZeroDevEthersProvider<V>) {\n    super();\n    this.account = this.provider.accountProvider.getAccount();\n\n    this.sendUserOperation =\n      this.provider.accountProvider.sendUserOperation.bind(\n        this.provider.accountProvider\n      );\n    this.waitForUserOperationTransaction =\n      this.provider.accountProvider.waitForUserOperationTransaction.bind(\n        this.provider.accountProvider\n      );\n  }\n\n  getAddress(): Promise<Hex> {\n    if (!this.account) {\n      throw new Error(\n        \"connect the signer to a provider that has a connected account\"\n      );\n    }\n\n    return this.account.getAddress();\n  }\n\n  signMessage(message: string | Uint8Array): Promise<string> {\n    if (!this.account) {\n      throw new Error(\n        \"connect the signer to a provider that has a connected account\"\n      );\n    }\n\n    return this.account.signMessage(message);\n  }\n\n  signTypedData(params: SignTypedDataParams): Promise<string> {\n    if (!this.account) {\n      throw new Error(\n        \"connect the signer to a provider that has a connected account\"\n      );\n    }\n    if (params.types) {\n      delete params.types[\"EIP712Domain\"];\n    }\n\n    return this.account.signTypedData(params);\n  }\n\n  _signTypedData(\n    domain: TypedDataDomain,\n    types: Record<string, Array<TypedDataField>>,\n    value: Record<string, any>\n  ): Promise<string> {\n    if (!this.account) {\n      throw new Error(\n        \"connect the signer to a provider that has a connected account\"\n      );\n    }\n    const params = _TypedDataEncoder.getPayload(\n      domain,\n      types,\n      value\n    ) as SignTypedDataParams;\n    if (params.types) {\n      delete params.types[\"EIP712Domain\"];\n    }\n\n    return this.signTypedData(params);\n  }\n\n  async signMessageWith6492(_msg: string | Uint8Array): Promise<Hex> {\n    if (!this.account) {\n      throw new Error(\n        \"connect the signer to a provider that has a connected account\"\n      );\n    }\n    return this.account.signMessageWith6492(_msg);\n  }\n\n  async signTypedDataWith6492(params: SignTypedDataParams): Promise<Hex> {\n    if (!this.account) {\n      throw new Error(\n        \"connect the signer to a provider that has a connected account\"\n      );\n    }\n    return this.account.signTypedDataWith6492(params);\n  }\n\n  withPaymasterMiddleware = (overrides: {\n    dummyPaymasterDataMiddleware?: PaymasterAndDataMiddleware;\n    paymasterDataMiddleware?: PaymasterAndDataMiddleware;\n  }): this => {\n    this.provider.withPaymasterMiddleware(overrides);\n    return this;\n  };\n\n  withGasEstimator = (override: GasEstimatorMiddleware): this => {\n    this.provider.withGasEstimator(override);\n    return this;\n  };\n\n  withFeeDataGetter = (override: FeeDataMiddleware): this => {\n    this.provider.withFeeDataGetter(override);\n    return this;\n  };\n\n  withCustomMiddleware = (override: AccountMiddlewareFn): this => {\n    this.provider.withCustomMiddleware(override);\n    return this;\n  };\n\n  async sendTransaction(\n    transaction: Deferrable<TransactionRequest>\n  ): Promise<TransactionResponse> {\n    const resolved = await resolveProperties(transaction);\n    const txHash = await this.provider.accountProvider.sendTransaction({\n      // TODO: need to support gas fields as well\n      from: (await this.getAddress()) as `0x${string}`,\n      to: resolved.to as `0x${string}` | undefined,\n      data: hexlifyOptional(resolved.data),\n      value: hexlifyOptional(resolved.value),\n    });\n\n    return this.provider.getTransaction(txHash);\n  }\n\n  signTransaction(\n    _transaction: Deferrable<TransactionRequest>\n  ): Promise<string> {\n    throw new Error(\n      \"Transaction signing is not supported, use sendUserOperation instead\"\n    );\n  }\n\n  getPublicErc4337Client(): PublicErc4337Client {\n    return this.provider.getPublicErc4337Client();\n  }\n\n  connect(provider: ZeroDevEthersProvider<V>): ZeroDevAccountSigner<V> {\n    return new ZeroDevAccountSigner(provider);\n  }\n}\n"]}